<!DOCTYPE html>
<html>
<head>
    <title>ASL Greeting Recognition</title>
    <style>
        body { 
            font-family: sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 20px;
        }
        #container { 
            display: flex; 
            align-items: flex-start; 
            gap: 20px;
            margin-top: 20px; 
        }
        #videoContainer {
            position: relative;
            width: 640px;
            height: 480px;
            border: 2px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }
        #webcamVideo { 
            display: block; 
            width: 100%; 
            height: 100%; 
            transform: scaleX(-1);  /* Mirror view */
            object-fit: cover;
        }
        #controls { 
            display: flex; 
            flex-direction: column; 
            gap: 10px;
        }
        button { 
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #predictionResult { 
            margin-top: 20px;
            font-size: 1.2em;
            font-weight: bold;
            padding: 10px;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        #status { 
            margin-top: 5px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>ASL Greeting Recognition</h1>
    <div id="container">
        <div id="videoContainer">
            <video id="webcamVideo" autoplay playsinline></video>
        </div>
        <div id="controls">
            <button id="startButton">Start Recording</button>
            <button id="stopButton" disabled>Stop Recording & Predict</button>
            <div id="predictionResult">Prediction: ---</div>
            <div id="status">Status: Initializing...</div>
        </div>
    </div>

    <script>
        const video = document.getElementById('webcamVideo');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const predictionResultDiv = document.getElementById('predictionResult');
        const statusDiv = document.getElementById('status');

        let isRecording = false;
        let recordedFrames = [];
        let recordingInterval;

        // Initialize webcam
        async function initializeWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: 640, 
                        height: 480,
                        facingMode: 'user'
                    } 
                });
                video.srcObject = stream;
                statusDiv.textContent = 'Status: Ready to record';
                startButton.disabled = false;
            } catch (err) {
                console.error('Error accessing webcam:', err);
                statusDiv.textContent = 'Error: Could not access webcam';
            }
        }

        // Capture a frame from the video
        function captureFrame() {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            // Flip horizontally if needed (mirror effect)
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            
            ctx.drawImage(video, 0, 0);
            return canvas.toDataURL('image/jpeg', 0.8);
        }

        // Start recording frames
        function startRecording() {
            isRecording = true;
            recordedFrames = [];
            startButton.disabled = true;
            stopButton.disabled = false;
            statusDiv.textContent = 'Status: Recording...';

            // Capture frames at regular intervals (e.g., every 100ms)
            recordingInterval = setInterval(() => {
                if (recordedFrames.length < 120) { // Limit to 120 frames
                    recordedFrames.push(captureFrame());
                } else {
                    stopRecording(); // Auto-stop when we have enough frames
                }
            }, 100); // 10 FPS
        }

        // Stop recording and send frames for prediction
        async function stopRecording() {
            isRecording = false;
            clearInterval(recordingInterval);
            startButton.disabled = false;
            stopButton.disabled = true;
            statusDiv.textContent = 'Status: Processing...';

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ frames: recordedFrames })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                if (result.error) {
                    throw new Error(result.error);
                }

                predictionResultDiv.textContent = `Prediction: ${result.prediction} (${(result.confidence * 100).toFixed(1)}%)`;
                statusDiv.textContent = 'Status: Ready to record';

            } catch (error) {
                console.error('Error:', error);
                statusDiv.textContent = `Error: ${error.message}`;
                predictionResultDiv.textContent = 'Prediction: Error occurred';
            }
        }

        // Event listeners
        startButton.addEventListener('click', startRecording);
        stopButton.addEventListener('click', stopRecording);

        // Initialize webcam when page loads
        initializeWebcam();
    </script>
</body>
</html>
